#!/bin/sh
DEVICE_MAC="84:D3:52:63:69:E8"
DEVICE_MAC_UNDERSCORE=$(echo "$DEVICE_MAC" | tr ':' '_')

# Turn bluetooth on
bluetoothctl power on

# Connect to the headset
bluetoothctl connect "$DEVICE_MAC"

# Wait up to 10 seconds for PipeWire to register the card
CARD=""
for i in $(seq 1 10); do
    CARD=$(pactl list cards short | grep -i "bluez_card.${DEVICE_MAC_UNDERSCORE}" | awk '{print $2}')
    if [ -n "$CARD" ]; then
        break
    fi
    sleep 1
done

if [ -z "$CARD" ]; then
    echo "❌ Could not find Bluetooth card for $DEVICE_MAC" >&2
    exit 1
fi

# Select the best available A2DP codec profile (ordered by quality)
AVAILABLE_PROFILES=$(pactl list cards | sed -n "/$(echo "$CARD" | sed 's/\./\\./g')/,/^$/p" | grep -oP '^\s+\K(a2dp-sink\S*?)(?=:)')
BEST_PROFILE=""
for codec in a2dp-sink-ldac a2dp-sink-aptx_hd a2dp-sink-aptx a2dp-sink-aac a2dp-sink-sbc_xq a2dp-sink-sbc a2dp-sink; do
    if echo "$AVAILABLE_PROFILES" | grep -qx "$codec"; then
        BEST_PROFILE="$codec"
        break
    fi
done

if [ -n "$BEST_PROFILE" ]; then
    echo "Setting profile: $BEST_PROFILE"
    pactl set-card-profile "$CARD" "$BEST_PROFILE"
    sleep 1
else
    echo "⚠️  No A2DP profile found, using default" >&2
fi

# Wait up to 10 seconds for PipeWire to register the sink
SINK=""
for i in $(seq 1 10); do
    SINK=$(pactl list short sinks | grep -i "bluez_output.${DEVICE_MAC}" | awk '{print $2}')
    if [ -n "$SINK" ]; then
        break
    fi
    sleep 1
done

if [ -n "$SINK" ]; then
    pactl set-default-sink "$SINK"
    for stream in $(pactl list short sink-inputs | awk '{print $1}'); do
        pactl move-sink-input "$stream" "$SINK"
    done
    echo "✅ Connected with $BEST_PROFILE → $SINK"
else
    echo "❌ Could not find sink for $DEVICE_MAC" >&2
fi

kill -46 "$(pidof dwmblocks)" 2>/dev/null
kill -44 "$(pidof dwmblocks)" 2>/dev/null
