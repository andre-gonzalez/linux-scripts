#!/bin/sh
# Toggle Dunst Do Not Disturb mode.
# Supports:
#   do-not-disturb H M   -> hours + minutes
#   do-not-disturb H     -> hours only (minutes = 0)
#   do-not-disturb       -> toggle without timer
#   do-not-disturb -h    -> show help

show_help() {
    cat << EOF
Usage: do-not-disturb [HOURS] [MINUTES]

Toggle Do Not Disturb (DND) mode on/off for dunst.
If HOURS and MINUTES are provided, DND stays enabled for that duration.

Examples:
  do-not-disturb          Toggle DND on/off immediately
  do-not-disturb 1        Enable DND for 1 hour
  do-not-disturb 0 30     Enable DND for 30 minutes
  do-not-disturb 1 15     Enable DND for 1 hour and 15 minutes
  do-not-disturb 1 0      Enable DND for 1 hour
  do-not-disturb -h       Show this help page

Notes:
- HOURS and MINUTES must be integers â‰¥ 0.
- If only HOURS is provided, MINUTES defaults to 0.
EOF
}

# Handle help flag
case "$1" in
    -h|--help)
        show_help
        exit 0
        ;;
esac

status="$(dunstctl is-paused)"

HOURS="${1:-}"
MINUTES="${2:-0}"

# If no args provided, toggle only
if [ -z "$1" ]; then
    TOTAL_SECONDS=0
else
    # Validate numeric input
    if ! [ "$HOURS" -ge 0 ] 2>/dev/null; then
        echo "Invalid hours value: $HOURS" >&2
        exit 1
    fi
    if ! [ "$MINUTES" -ge 0 ] 2>/dev/null; then
        echo "Invalid minutes value: $MINUTES" >&2
        exit 1
    fi

    TOTAL_SECONDS=$(( HOURS * 3600 + MINUTES * 60 ))
fi

do_not_disturb_off() {
    dunstctl set-paused false
    notify-send "Do not disturb OFF"
    kill -48 "$(pidof dwmblocks)"
}

if [ "$status" = "false" ]; then
    dunstctl set-paused true
    echo "Do not disturb ON" | dmenu
    kill -48 "$(pidof dwmblocks)"

    # Only sleep if user provided a time
    if [ "$TOTAL_SECONDS" -gt 0 ]; then
        sleep "$TOTAL_SECONDS"
        do_not_disturb_off
    fi

elif [ "$status" = "true" ]; then
    do_not_disturb_off
fi
