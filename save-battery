#!/bin/sh

# Enhanced Battery Saving Script with Dual Profiles
# Profiles: Maximum Battery (aggressive) and Balanced (moderate)
# Usage examples
 # Interactive mode (prompts for each action)
 # ./save-battery

 # Apply maximum battery profile automatically
 # ./save-battery --profile maximum --auto

 # Apply balanced profile with prompts
 # ./save-battery --profile balanced

 # Restore normal state
 # ./save-battery --restore

 # Check current status
 # ./save-battery --status

STATE_FILE="/tmp/save-battery-state.json"
TLP_CONFIG="/etc/tlp.conf"
TLP_BACKUP="/tmp/tlp.conf.backup"
PROMPT_SCRIPT="/home/frank/.scripts/prompt.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log() {
	local msg="$1"
	echo "[$(date '+%H:%M:%S')] $msg" | tee -a /tmp/save-battery.log 2>/dev/null || echo "[$(date '+%H:%M:%S')] $msg"
}

# Prompt and execute command if user says Yes
prompt_and_execute() {
	local question="$1"
	local command="$2"

	if [ -z "$question" ] || [ -z "$command" ]; then
		return 1
	fi

	# Ask user
	local answer=$(echo "No\nYes" | dmenu -p "$question" 2>/dev/null)

	# Only execute if user said Yes
	if [ "$answer" = "Yes" ]; then
		eval "$command"
		return $?
	else
		return 1
	fi
}

# Check if running as root for TLP operations
check_sudo() {
	if ! sudo -n true 2>/dev/null; then
		log "${YELLOW}Note: Some operations require sudo privileges${NC}"
	fi
}

# Backup TLP configuration
backup_tlp_config() {
	if [ -f "$TLP_CONFIG" ] && [ ! -f "$TLP_BACKUP" ]; then
		log "Backing up TLP configuration..."
		sudo cp "$TLP_CONFIG" "$TLP_BACKUP" 2>/dev/null || {
			log "${RED}Failed to backup TLP config${NC}"
			return 1
		}
		log "${GREEN}TLP config backed up${NC}"
	fi
}

# Restore TLP configuration
restore_tlp_config() {
	if [ -f "$TLP_BACKUP" ]; then
		log "Restoring TLP configuration..."
		sudo cp "$TLP_BACKUP" "$TLP_CONFIG" 2>/dev/null || {
			log "${RED}Failed to restore TLP config${NC}"
			return 1
		}
		sudo tlp start 2>/dev/null
		log "${GREEN}TLP config restored${NC}"
		rm -f "$TLP_BACKUP"
	fi
}

# Configure TLP for a specific profile
configure_tlp() {
	local profile="$1"
	local interactive="$2"

	if [ ! -f "$TLP_CONFIG" ]; then
		log "${RED}TLP configuration not found at $TLP_CONFIG${NC}"
		return 1
	fi

	# Ask once in interactive mode
	if [ "$interactive" = "true" ]; then
		local answer=$(echo "No\nYes" | dmenu -p "Configure TLP for $profile profile?" 2>/dev/null)
		if [ "$answer" != "Yes" ]; then
			log "Skipping TLP configuration"
			return 0
		fi
	fi

	backup_tlp_config

	log "Configuring TLP for profile: $profile"

	# Maximum Battery profile - aggressive settings
	if [ "$profile" = "maximum" ]; then
		apply_tlp_setting "CPU_SCALING_GOVERNOR_ON_BAT" "powersave"
		apply_tlp_setting "CPU_ENERGY_PERF_POLICY_ON_BAT" "power"
		apply_tlp_setting "CPU_BOOST_ON_BAT" "0"
		apply_tlp_setting "CPU_HWP_DYN_BOOST_ON_BAT" "0"
		apply_tlp_setting "PLATFORM_PROFILE_ON_BAT" "low-power"
		apply_tlp_setting "SATA_LINKPWR_ON_BAT" "min_power"
		apply_tlp_setting "PCIE_ASPM_ON_BAT" "powersupersave"
		apply_tlp_setting "DISK_SPINDOWN_TIMEOUT_ON_BAT" "0 1"
		apply_tlp_setting "DISK_APM_LEVEL_ON_BAT" "1 1"
		apply_tlp_setting "WIFI_PWR_ON_BAT" "on"
		apply_tlp_setting "SOUND_POWER_SAVE_ON_BAT" "1"
		apply_tlp_setting "RADEON_DPM_STATE_ON_BAT" "battery" 2>/dev/null
		apply_tlp_setting "RADEON_DPM_PERF_LEVEL_ON_BAT" "auto" 2>/dev/null
		apply_tlp_setting "NVIDIA_DYNAMIC_POWER_MANAGEMENT_ON_BAT" "1" 2>/dev/null
		apply_tlp_setting "CPU_MIN_PERF_ON_BAT" "0" 2>/dev/null
		apply_tlp_setting "CPU_MAX_PERF_ON_BAT" "30" 2>/dev/null

	# Balanced profile - moderate settings
	elif [ "$profile" = "balanced" ]; then
		apply_tlp_setting "CPU_SCALING_GOVERNOR_ON_BAT" "powersave"
		apply_tlp_setting "CPU_ENERGY_PERF_POLICY_ON_BAT" "balance_power"
		apply_tlp_setting "CPU_BOOST_ON_BAT" "0"
		apply_tlp_setting "CPU_HWP_DYN_BOOST_ON_BAT" "0"
		apply_tlp_setting "PLATFORM_PROFILE_ON_BAT" "low-power"
		apply_tlp_setting "SATA_LINKPWR_ON_BAT" "min_power"
		apply_tlp_setting "PCIE_ASPM_ON_BAT" "powersave"
		apply_tlp_setting "DISK_SPINDOWN_TIMEOUT_ON_BAT" "0 5"
		apply_tlp_setting "DISK_APM_LEVEL_ON_BAT" "128 128"
		apply_tlp_setting "WIFI_PWR_ON_BAT" "on"
		apply_tlp_setting "SOUND_POWER_SAVE_ON_BAT" "1"
		apply_tlp_setting "CPU_MIN_PERF_ON_BAT" "20" 2>/dev/null
		apply_tlp_setting "CPU_MAX_PERF_ON_BAT" "60" 2>/dev/null
	fi

	# Reload TLP
	log "Reloading TLP..."
	sudo tlp bat 2>/dev/null || sudo tlp start 2>/dev/null
	log "${GREEN}TLP configured for $profile profile${NC}"
}

# Apply a TLP setting
apply_tlp_setting() {
	local setting="$1"
	local value="$2"

	# Check if setting exists in config
	if grep -q "^${setting}=" "$TLP_CONFIG" 2>/dev/null; then
		# Update existing setting
		sudo sed -i "s|^${setting}=.*|${setting}=${value}|" "$TLP_CONFIG" 2>/dev/null
	else
		# Add new setting (find appropriate section)
		log "Setting $setting not found, adding to config..."
		sudo sh -c "echo \"${setting}=${value}\" >> $TLP_CONFIG" 2>/dev/null
	fi
}

# Save state for restoration
save_state() {
	local profile="$1"
	local state="{\"profile\":\"$profile\",\"timestamp\":\"$(date +%s)\",\"applications\":[],\"services\":[]}"
	echo "$state" > "$STATE_FILE"
}

# Kill applications based on profile
kill_applications() {
	local profile="$1"
	local interactive="$2"

	# Applications to kill for Maximum Battery profile
	if [ "$profile" = "maximum" ]; then
		local apps="insync spotify_player firefox chrome brave chromium discord slack telegram thunderbird evolution dropbox onedrive nextcloud vlc mpv obs studio steam lutris wine redshift dunst newsboat dwmblocks unclutter"
	# Applications to kill for Balanced profile (only resource-heavy)
	elif [ "$profile" = "balanced" ]; then
		local apps="spotify_player discord slack steam lutris obs"
	fi

	# Whitelist - never kill these
	local whitelist="dwm st alacritty kitty xterm urxvt systemd dbus"

	log "Scanning for applications to terminate..."

	for app in $apps; do
		# Check if process is running
		local pids=$(pgrep -f "$app" 2>/dev/null | grep -v "^$$$")

		if [ -n "$pids" ]; then
			# Check if it's whitelisted
			local is_whitelisted=false
			for white in $whitelist; do
				if echo "$app" | grep -qi "$white"; then
					is_whitelisted=true
					break
				fi
			done

			if [ "$is_whitelisted" = "false" ]; then
				if [ "$interactive" = "true" ]; then
					if prompt_and_execute "Kill $app?" "killall -TERM '$app' 2>/dev/null"; then
						log "Killed $app"
						# Save to state
						local state=$(cat "$STATE_FILE" 2>/dev/null || echo '{"applications":[]}')
						# Simple append (basic JSON handling)
						echo "$app" >> /tmp/save-battery-killed-apps.txt 2>/dev/null
					fi
				else
					if killall -TERM "$app" 2>/dev/null; then
						log "Killed $app"
						echo "$app" >> /tmp/save-battery-killed-apps.txt 2>/dev/null
					fi
				fi
			fi
		fi
	done
}

# Manage system services
manage_services() {
	local profile="$1"
	local interactive="$2"
	local action="$3"  # "stop" or "start"

	# Services to manage for Maximum Battery profile
	if [ "$profile" = "maximum" ]; then
		local services="tailscaled preload libvirtd docker docker.socket containerd awsvpnclient cronie iwd systemd-networkd ufw firewalld fail2ban apparmor bluetooth"
	# Services to manage for Balanced profile
	elif [ "$profile" = "balanced" ]; then
		local services="tailscaled preload libvirtd docker docker.socket containerd awsvpnclient"
	fi

	# Never stop these critical services
	local critical_services="systemd dbus NetworkManager network-manager"

	for service in $services; do
		local is_critical=false
		for crit in $critical_services; do
			if echo "$service" | grep -qi "$crit"; then
				is_critical=true
				break
			fi
		done

		if [ "$is_critical" = "false" ]; then
			if [ "$action" = "stop" ]; then
				if systemctl is-active --quiet "$service" 2>/dev/null; then
					if [ "$interactive" = "true" ]; then
						if prompt_and_execute "Stop service $service?" "sudo systemctl stop '$service' 2>/dev/null"; then
							log "Stopped service: $service"
							echo "$service" >> /tmp/save-battery-stopped-services.txt 2>/dev/null
						fi
					else
						if sudo systemctl stop "$service" 2>/dev/null; then
							log "Stopped service: $service"
							echo "$service" >> /tmp/save-battery-stopped-services.txt 2>/dev/null
						fi
					fi
				fi
			elif [ "$action" = "start" ]; then
				if systemctl is-enabled --quiet "$service" 2>/dev/null; then
					if sudo systemctl start "$service" 2>/dev/null; then
						log "Started service: $service"
					fi
				fi
			fi
		fi
	done
}

# Manage display settings
manage_display() {
	local profile="$1"
	local interactive="$2"

	if [ "$profile" = "maximum" ]; then
		# Maximum Battery: Very low brightness, black wallpaper, aggressive DPMS
		if [ "$interactive" = "true" ]; then
			prompt_and_execute "Set brightness to 1%?" "brightnessctl set 1% 2>/dev/null && kill -45 \$(pidof dwmblocks) 2>/dev/null"
			prompt_and_execute "Set black wallpaper?" "feh --bg-fill /home/frank/.config/.wallpaper/black.png 2>/dev/null"
			prompt_and_execute "Set DPMS to 60 seconds?" "xset dpms 60 60 60 2>/dev/null"
			prompt_and_execute "Disable HDMI-1 output?" "xrandr --output HDMI-1 --off 2>/dev/null"
		else
			brightnessctl set 1% 2>/dev/null && kill -45 $(pidof dwmblocks) 2>/dev/null
			feh --bg-fill "/home/frank"/.config/.wallpaper/black.png 2>/dev/null
			xset dpms 60 60 60 2>/dev/null
			xrandr --output HDMI-1 --off 2>/dev/null
		fi
		log "Display configured for maximum battery"

	elif [ "$profile" = "balanced" ]; then
		# Balanced: Reduced brightness, moderate DPMS
		if [ "$interactive" = "true" ]; then
			prompt_and_execute "Set brightness to 30%?" "brightnessctl set 30% 2>/dev/null && kill -45 \$(pidof dwmblocks) 2>/dev/null"
			prompt_and_execute "Set DPMS to 120 seconds?" "xset dpms 120 120 120 2>/dev/null"
			prompt_and_execute "Disable HDMI-1 output?" "xrandr --output HDMI-1 --off 2>/dev/null"
		else
			brightnessctl set 30% 2>/dev/null && kill -45 $(pidof dwmblocks) 2>/dev/null
			xset dpms 120 120 120 2>/dev/null
			xrandr --output HDMI-1 --off 2>/dev/null
		fi
		log "Display configured for balanced profile"
	fi
}

# Manage hardware (GPU, Bluetooth, WiFi)
manage_hardware() {
	local profile="$1"
	local interactive="$2"

	if [ "$profile" = "maximum" ]; then
		# Maximum Battery: Disable discrete GPU, Bluetooth, WiFi
		if [ "$interactive" = "true" ]; then
			prompt_and_execute "Switch to integrated GPU?" "envycontrol -s integrated 2>/dev/null"
			prompt_and_execute "Disable Bluetooth?" "bluetoothctl power off 2>/dev/null; sudo systemctl stop bluetooth 2>/dev/null"
			prompt_and_execute "Disable WiFi?" "rfkill block wifi 2>/dev/null"
			prompt_and_execute "Disable swap?" "sudo swapoff -a 2>/dev/null"
		else
			envycontrol -s integrated 2>/dev/null
			bluetoothctl power off 2>/dev/null
			sudo systemctl stop bluetooth 2>/dev/null
			rfkill block wifi 2>/dev/null
			sudo swapoff -a 2>/dev/null
		fi
		log "Hardware configured for maximum battery"

	elif [ "$profile" = "balanced" ]; then
		# Balanced: Switch to integrated GPU, disable Bluetooth
		if [ "$interactive" = "true" ]; then
			prompt_and_execute "Switch to integrated GPU?" "envycontrol -s integrated 2>/dev/null"
			prompt_and_execute "Disable Bluetooth?" "bluetoothctl power off 2>/dev/null; sudo systemctl stop bluetooth 2>/dev/null"
		else
			envycontrol -s integrated 2>/dev/null
			bluetoothctl power off 2>/dev/null
			sudo systemctl stop bluetooth 2>/dev/null
		fi
		log "Hardware configured for balanced profile"
	fi
}

# Manage audio (pipewire, pulseaudio)
manage_audio() {
	local profile="$1"
	local interactive="$2"

	if [ "$profile" = "maximum" ]; then
		if [ "$interactive" = "true" ]; then
			prompt_and_execute "Stop PipeWire?" "killall pipewire pipewire-pulse wireplumber 2>/dev/null"
		else
			killall pipewire pipewire-pulse wireplumber 2>/dev/null
		fi
		log "Audio services stopped"
	fi
}

# Apply a profile
apply_profile() {
	local profile="$1"
	local interactive="$2"

	if [ -z "$profile" ]; then
		log "${RED}No profile specified${NC}"
		return 1
	fi

	if [ "$profile" != "maximum" ] && [ "$profile" != "balanced" ]; then
		log "${RED}Invalid profile: $profile${NC}"
		return 1
	fi

	log "${GREEN}Applying profile: $profile${NC}"

	# Save state
	save_state "$profile"

	# Configure TLP
	configure_tlp "$profile" "$interactive"

	# Kill applications
	kill_applications "$profile" "$interactive"

	# Stop services
	manage_services "$profile" "$interactive" "stop"

	# Manage display
	manage_display "$profile" "$interactive"

	# Manage hardware
	manage_hardware "$profile" "$interactive"

	# Manage audio (only for maximum)
	if [ "$profile" = "maximum" ]; then
		manage_audio "$profile" "$interactive"
	fi

	# Additional actions for maximum profile
	if [ "$profile" = "maximum" ]; then
		if [ "$interactive" = "true" ]; then
			prompt_and_execute "Stop compositor?" "/bin/sh /home/frank/.scripts/start-stop-compositor.sh 2>/dev/null"
		else
			/bin/sh /home/frank/.scripts/start-stop-compositor.sh 2>/dev/null
		fi

		# Activate undervolt if available
		if [ "$interactive" = "true" ]; then
			prompt_and_execute "Activate CPU undervolt?" "sudo systemctl restart intel-undervolt 2>/dev/null"
		else
			sudo systemctl restart intel-undervolt 2>/dev/null
		fi
	fi

	# Activate undervolt for balanced profile as well
	if [ "$profile" = "balanced" ]; then
		if [ "$interactive" = "true" ]; then
			prompt_and_execute "Activate CPU undervolt?" "sudo systemctl restart intel-undervolt 2>/dev/null"
		else
			sudo systemctl restart intel-undervolt 2>/dev/null
		fi
	fi

	log "${GREEN}Profile $profile applied successfully${NC}"
}

# Restore normal state
restore_normal() {
	log "${GREEN}Restoring normal state...${NC}"

	# Restore TLP config
	restore_tlp_config

	# Restore services
	if [ -f /tmp/save-battery-stopped-services.txt ]; then
		while read -r service; do
			if [ -n "$service" ]; then
				sudo systemctl start "$service" 2>/dev/null && log "Restored service: $service"
			fi
		done < /tmp/save-battery-stopped-services.txt
		rm -f /tmp/save-battery-stopped-services.txt
	fi

	# Restore display
	brightnessctl set 100% 2>/dev/null && kill -45 $(pidof dwmblocks) 2>/dev/null
	xset dpms 600 600 600 2>/dev/null

	# Restore hardware
	rfkill unblock wifi 2>/dev/null
	rfkill unblock bluetooth 2>/dev/null
	sudo systemctl start bluetooth 2>/dev/null
	sudo swapon -a 2>/dev/null

	# Clean up state files
	rm -f "$STATE_FILE" /tmp/save-battery-killed-apps.txt

	log "${GREEN}Normal state restored${NC}"
}

# Show current status
show_status() {
	if [ -f "$STATE_FILE" ]; then
		local profile=$(grep -o '"profile":"[^"]*"' "$STATE_FILE" 2>/dev/null | cut -d'"' -f4)
		if [ -n "$profile" ]; then
			log "Current active profile: ${GREEN}$profile${NC}"
		else
			log "No active profile"
		fi
	else
		log "No active profile"
	fi
}

# Check dependencies
check_dependencies() {
	local missing=""

	# Check for dmenu (needed for interactive mode)
	if ! command -v dmenu >/dev/null 2>&1; then
		missing="$missing dmenu"
	fi

	# Check for TLP
	if ! command -v tlp >/dev/null 2>&1; then
		log "${YELLOW}Warning: TLP not found. TLP configuration will be skipped.${NC}"
	fi

	# Check for systemctl
	if ! command -v systemctl >/dev/null 2>&1; then
		log "${YELLOW}Warning: systemctl not found. Service management will be limited.${NC}"
	fi

	if [ -n "$missing" ]; then
		log "${YELLOW}Warning: Missing dependencies:$missing${NC}"
	fi
}

# Main function
main() {
	local profile=""
	local interactive="true"
	local restore=false

	# Check dependencies
	check_dependencies

	# Parse arguments
	while [ $# -gt 0 ]; do
		case "$1" in
			--profile|--p)
				profile="$2"
				shift 2
				;;
			--auto|-a)
				interactive="false"
				shift
				;;
			--interactive|-i)
				interactive="true"
				shift
				;;
			--restore|-r)
				restore=true
				shift
				;;
			--status|-s)
				show_status
				exit 0
				;;
			--help|-h)
				echo "Usage: $0 [OPTIONS]"
				echo ""
				echo "Options:"
				echo "  --profile, -p PROFILE    Profile to apply (maximum|balanced)"
				echo "  --auto, -a                Apply changes automatically (no prompts)"
				echo "  --interactive, -i         Apply changes with prompts (default)"
				echo "  --restore, -r             Restore normal state"
				echo "  --status, -s              Show current profile status"
				echo "  --help, -h                Show this help message"
				echo ""
				echo "Profiles:"
				echo "  maximum   - Maximum battery life (aggressive power saving)"
				echo "  balanced  - Balanced performance and battery saving"
				exit 0
				;;
			*)
				log "${RED}Unknown option: $1${NC}"
				exit 1
				;;
		esac
	done

	# Handle restore
	if [ "$restore" = "true" ]; then
		restore_normal
		exit 0
	fi

	# If no profile specified, prompt user
	if [ -z "$profile" ]; then
		local options="Maximum Battery\nBalanced\nRestore Normal"
		if [ -f "$STATE_FILE" ]; then
			options="Maximum Battery\nBalanced\nRestore Normal"
		fi

		profile=$(echo "$options" | dmenu -p "Select battery profile:" 2>/dev/null)

		if [ -z "$profile" ]; then
			log "${YELLOW}No profile selected${NC}"
			exit 0
		fi

		case "$profile" in
			"Maximum Battery")
				profile="maximum"
				;;
			"Balanced")
				profile="balanced"
				;;
			"Restore Normal")
				restore_normal
				exit 0
				;;
			*)
				log "${RED}Invalid selection${NC}"
				exit 1
				;;
		esac
	fi

	# Apply profile
	apply_profile "$profile" "$interactive"
}

# Run main function
main "$@"
